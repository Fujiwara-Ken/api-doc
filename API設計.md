# API 設計で考慮すること

## URI 設計

- 短く入力しやすいこと(冗長なパスを含まない)
  ⇨ シンプルで覚えやすいものにすることで入力ミスを防ぐ
- 人間が読んで理解できる(省略しない)
- 大文字小文字を含まない(混在しない)
- 単語はハイフンで繋げる
  ⇨ アンスコはタイプライターで下線を引くためのもの。ハイフンは単語をつなぐためのもの
- 単語は複数形を利用する
  ⇨ URI で表現しているのはリソースの集合
- エンコードを必要とする文字は使わない
  ⇨ URI から意味が理解できないため
- サーバー側のアーキテクチャを反映しない
  ⇨ 悪意のあるユーザーに脆弱性を突かれる危険性がある
- 改造しやすい
  ⇨ システム依存の設計では意味が理解できない
- ルールが統一されている

## クエリとパスの使い分け

_クエリパラメーター_
URL の末尾にある ? に続くキーバリュー
例 : http://api.example.com/users?page=3

_パスパラメーター_
URL 中に埋め込まれるパラメーター(userId 等)
例 : http://api.example.com/users/123

- 一意なリソースを表すのに必要かどうか
  ⇨ パスパラメーターを利用
- 省略可能かどうか
  ⇨ クエリパラメーターを利用

## 内部構造設計で考慮すること

- エンベロープは使わない
  ⇨ ヘッダー情報と役割が被るため
- オブジェクトはできるだけフラットにする
  ⇨ レスポンス容量が増えるのを防ぐため
- ページネーションをサポートする情報を返す
  ⇨ json 内に nextPage: 1 のような値は入れない
  ⇨ 情報更新される可能性があるため
  hasNext: true nextPageToken のような、キーとなる情報を返す
- プロパティの命名規則は API 全体で統一する
  ⇨ 利用者が混乱するため
  スネークケース or キャメルケース
- 日付は RFC3339 を使う
  ⇨ RFC822, RFC850, UNIX タイムスタンプは NG
- 大きな数値(64bit 整数)は文字列で返す

## エラー表現

- エラー詳細はレスポンスボディに入れる
- エラーの際に html が返らないようにする
  ⇨ レスポンスフォーマットが変わるとクライアントアプリ側で処理できないケースがある
- サービス閉塞時は 503 + Retry-After で返却する
  ⇨ クライアント側から見ていつから再開してよいかわかるため

## Rate Limit

設計考慮点

- 誰に対して : APIkey, user-id
- 何に対して : 単一機能、機能群、API 全体
- 制限回数 :
- 単位時間 : リセットするタイミング
- Sliding Window を用いてレートリミットをかけているか
- アクセス制限の緩和
  例 : 優良顧客の場合、キャンペーンなどの一時負荷増大
  ⇨ アクセス元ごとに一時的に設定変更できる仕組みを考慮しているか

## キャッシュ制御

## セキュリティ

- XSS : レスポンスヘッダーの追加
  X-XSS-Protection : "1" で XSS フィルタリング有効化
  X-Frame-Options : "DENY" で frame タグ呼び出しを拒否
  X-Content-Type-Options: "nisniff" で IE 脆弱性対応

- CSRF : 本来拒否しなければいけないアクセス元からくるリクエストを処理してしまう問題
  対策 : 許可しないアクセス元からのリクエストを拒否 :
  X-API-Key : システム単位で実行可否判断
  Authentication : ユーザー単位で実行可否判断
  攻撃者に推測されにくいトークンの発行 / 照合処理を実装
  X-CSRF-TOKEN: トークンを使って実行可否判断

- HTTP 通信経路が暗号化されないので盗聴されやすい
  対策 : 常時 HTTPS を利用した通信にする

SSL : 安全に通信を行うためのプロトコル 2015 年に使用禁止
TLS: 安全に通信を行うためのプロトコル SSL の後継
HTTPS: HTTP + SSL/TLS Web で安全に通信するプロトコル

- JWT: クライアント側で内容の確認/編集が簡単にできるため、サーバー側の検証が不十分だと
  改ざんされた情報を正規として受け入れてしまう

対策

- ヘッダーの alg に none 以外を指定して署名を暗号化する

```json
{
  "type": "JWT",
  "alg": "ES256"
}
```

- ペイロードの aud に想定する利用者を指定して、受信時に検証する

```json
{
  "sub": "1234567890",
  "name": "myoji kana",
  "aud": "https://api/example/com/"
}
```
